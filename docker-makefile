# Get the current path for the container name
CURRENT_PATH  := $(notdir $(patsubst %/,%,$(CURDIR)))

# the registry we are targetting, example of pushing to the global docker registry
# REPO_URI     := tlrg/
REPO_URI      := docker-registry.laterooms.io:5000

# Sets the name of the container being built, in this case the dir name we are in
NAME          := ${CURRENT_PATH}

# Set your version tag here, examples for git short tag and date below
# TAG          := $(shell date +%Y%m%d%H%M%S)
TAG           := $(shell git rev-parse --short HEAD)

# Temp name to build against to avoid name clashes
IMG_BUILD     := ${NAME}:tmp

# Full final tag name to push to as well as latest
IMG           := ${REPO_URI}/${NAME}:${TAG}
LATEST        := ${REPO_URI}/${NAME}:latest

all: pull build test tag push

# Pull the latest version for build speed ups, and the tag we are building to avoid dups
pull:
	-@docker pull ${LATEST} && (echo "docker tag already exists"; exit 1)
	-@docker pull ${IMG}

# Build a container with a temp tag to avoid clashes
build:
	@docker build -t ${IMG_BUILD} .

# Test your docker container works, this example is for logstash 
test:
	@docker run --name ${NAME}_${TAG} ${IMG_BUILD} -t
# Clean up post test if successful, to allow for docker logs
	@docker rm ${NAME}_${TAG}

# Tag your container with the version tag and latest
tag:
	@docker tag ${IMG_BUILD} ${IMG}
	@docker tag ${IMG_BUILD} ${LATEST}

# Push your container out to the registery
push:
	@docker push ${IMG}
	@docker push ${LATEST}
	@echo Pushed to ${IMG}

# If you need to login to your registry
login:
	@docker log -u ${DOCKER_USER} -p ${DOCKER_PASS}

# Delete any container images we have built
clean:
	-@docker images -q "*/${NAME}" | xargs docker image rm
	-@docker rmi ${IMG_BUILD}
	-@docker rm ${NAME}_${TAG}
